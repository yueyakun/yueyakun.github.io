(window.webpackJsonp=window.webpackJsonp||[]).push([[36],{521:function(t,a,s){"use strict";s.r(a);var n=s(4),r=Object(n.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"起因"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#起因"}},[t._v("#")]),t._v(" 起因")]),t._v(" "),s("p",[t._v("我的博客是用 Nginx 部署的，最近在看 Nginx 访问日志的时候总是看到一些奇怪的访问记录。\n比如下面这些访问路径：")]),t._v(" "),s("p",[t._v("/phpmyadmin/\n/uge.top\n/mysql/admin/index.php\n/mysql/dbadmin/index.php\n/mysql/sqlmanager/index.php")]),t._v(" "),s("p",[t._v("打眼一看就知道这些访问肯定不是善意的，又按 ip 统计了一下访问次数发下有几个 ip 的访问次数很异常：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/posts/2020/2020-12-07-nginx-access-log-analysis/01.png",alt:""}})]),t._v(" "),s("p",[t._v("再查一下访问量前几名几个ip访问的页面，发现全是在访问 /phpmyadmin/ 和 /uge.top 这两个路径，猜测可能是黑产在扫描互联网。\n嘿，合着我这小破站折磨点访问量还都是机器人啊，扎心了啊。。。")]),t._v(" "),s("p",[s("img",{attrs:{src:"/posts/2020/2020-12-07-nginx-access-log-analysis/02.png",alt:""}})]),t._v(" "),s("p",[t._v("哈哈，不管了给 Nginx 设置个黑名单吧！")]),t._v(" "),s("h2",{attrs:{id:"nginx-黑名单设置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nginx-黑名单设置"}},[t._v("#")]),t._v(" Nginx 黑名单设置")]),t._v(" "),s("h3",{attrs:{id:"创建-ip-black-黑名单文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建-ip-black-黑名单文件"}},[t._v("#")]),t._v(" 创建 ip.black 黑名单文件")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("#nginx拒绝访问ip\ndeny 212.64.58.60;\ndeny 93.243.88.232;\ndeny 72.87.95.36;\n\n")])])]),s("h3",{attrs:{id:"修改-nginx-conf-配置文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#修改-nginx-conf-配置文件"}},[t._v("#")]),t._v(" 修改 nginx.conf 配置文件")]),t._v(" "),s("p",[t._v("在 http 配置中加入黑名单配置")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("http {   \n    #配置黑名单文件地址\n    include ip.black\n}\n\n")])])]),s("h3",{attrs:{id:"重启-nginx-服务，配置完成。"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#重启-nginx-服务，配置完成。"}},[t._v("#")]),t._v(" 重启 Nginx 服务，配置完成。")]),t._v(" "),s("h2",{attrs:{id:"一些-nginx-访问日志统计命令"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一些-nginx-访问日志统计命令"}},[t._v("#")]),t._v(" 一些 Nginx 访问日志统计命令")]),t._v(" "),s("p",[t._v("再列出一些常用的 access.log 文件的统计分析命令：")]),t._v(" "),s("h3",{attrs:{id:"ip相关统计"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ip相关统计"}},[t._v("#")]),t._v(" IP相关统计")]),t._v(" "),s("p",[t._v("统计IP访问量\nawk '{print $1}' access.log | sort -n | uniq | wc -l")]),t._v(" "),s("p",[t._v("查看某一时间段的IP访问量(4-5点)\ngrep \"07/Apr/2017:0[4-5]\" access.log | awk '{print $1}' | sort | uniq -c| sort -nr | wc -l")]),t._v(" "),s("p",[t._v("查看访问最频繁的前100个IP\nawk '{print $1}' access.log | sort -n |uniq -c | sort -rn | head -n 100")]),t._v(" "),s("p",[t._v("查看访问100次以上的IP\nawk '{print $1}' access.log | sort -n |uniq -c |awk '{if($1 >100) print $0}'|sort -rn")]),t._v(" "),s("p",[t._v("查询某个IP的详细访问情况,按访问频率排序\ngrep '104.217.108.66' access.log |awk '{print $7}'|sort |uniq -c |sort -rn |head -n 100")]),t._v(" "),s("h3",{attrs:{id:"页面访问统计"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#页面访问统计"}},[t._v("#")]),t._v(" 页面访问统计")]),t._v(" "),s("p",[t._v("查看访问最频的页面(TOP100)\nawk '{print $7}' access.log | sort |uniq -c | sort -rn | head -n 100")]),t._v(" "),s("p",[t._v("查看访问最频的页面([排除php页面】(TOP100)\ngrep -v \".php\"  access.log | awk '{print $7}' | sort |uniq -c | sort -rn | head -n 100")]),t._v(" "),s("p",[t._v("查看页面访问次数超过100次的页面\ncat access.log | cut -d ' ' -f 7 | sort |uniq -c | awk '{if ($1 > 100) print $0}' | less")]),t._v(" "),s("p",[t._v("查看最近1000条记录，访问量最高的页面\ntail -1000 access.log |awk '{print $7}'|sort|uniq -c|sort -nr|less")]),t._v(" "),s("h3",{attrs:{id:"每秒请求量统计"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#每秒请求量统计"}},[t._v("#")]),t._v(" 每秒请求量统计")]),t._v(" "),s("p",[t._v("统计每秒的请求数,top100的时间点(精确到秒)\nawk '{print $4}' access.log |cut -c 14-21|sort|uniq -c|sort -nr|head -n 100")]),t._v(" "),s("h3",{attrs:{id:"每分钟请求量统计"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#每分钟请求量统计"}},[t._v("#")]),t._v(" 每分钟请求量统计")]),t._v(" "),s("p",[t._v("统计每分钟的请求数,top100的时间点(精确到分钟)\nawk '{print $4}' access.log |cut -c 14-18|sort|uniq -c|sort -nr|head -n 100")]),t._v(" "),s("h3",{attrs:{id:"每小时请求量统计"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#每小时请求量统计"}},[t._v("#")]),t._v(" 每小时请求量统计")]),t._v(" "),s("p",[t._v("统计每小时的请求数,top100的时间点(精确到小时)\nawk '{print $4}' access.log |cut -c 14-15|sort|uniq -c|sort -nr|head -n 100")]),t._v(" "),s("h3",{attrs:{id:"性能分析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#性能分析"}},[t._v("#")]),t._v(" 性能分析")]),t._v(" "),s("p",[t._v("在nginx log中最后一个字段加入$request_time")]),t._v(" "),s("p",[t._v("列出传输时间超过 3 秒的页面，显示前20条\ncat access.log|awk '($NF > 3){print $7}'|sort -n|uniq -c|sort -nr|head -20")]),t._v(" "),s("p",[t._v("列出php页面请求时间超过3秒的页面，并统计其出现的次数，显示前100条\ncat access.log|awk '($NF > 1 &&  $7~/.php/){print $7}'|sort -n|uniq -c|sort -nr|head -100")]),t._v(" "),s("h3",{attrs:{id:"蜘蛛抓取统计"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#蜘蛛抓取统计"}},[t._v("#")]),t._v(" 蜘蛛抓取统计")]),t._v(" "),s("p",[t._v("统计蜘蛛抓取次数\ngrep 'Baiduspider' access.log |wc -l")]),t._v(" "),s("p",[t._v("统计蜘蛛抓取404的次数\ngrep 'Baiduspider' access.log |grep '404' | wc -l")]),t._v(" "),s("h3",{attrs:{id:"tcp连接统计"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#tcp连接统计"}},[t._v("#")]),t._v(" TCP连接统计")]),t._v(" "),s("p",[t._v('查看当前TCP连接数\nnetstat -tan | grep "ESTABLISHED" | grep ":80" | wc -l')]),t._v(" "),s("p",[t._v('用tcpdump嗅探80端口的访问看看谁最高\ntcpdump -i eth0 -tnn dst port 80 -c 1000 | awk -F"." \'{print $1"."$2"."$3"."$4}\' | sort | uniq -c | sort -nr')])])}),[],!1,null,null,null);a.default=r.exports}}]);