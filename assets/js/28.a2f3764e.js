(window.webpackJsonp=window.webpackJsonp||[]).push([[28],{514:function(s,t,e){"use strict";e.r(t);var a=e(4),r=Object(a.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h3",{attrs:{id:"问题"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#问题"}},[s._v("#")]),s._v(" 问题")]),s._v(" "),e("p",[s._v("最近在尝试使用 jenkins 启动 Jar 包，构建顺利完成，但是后端服务却并没有启动。")]),s._v(" "),e("p",[s._v("构建日志如下：")]),s._v(" "),e("p",[e("img",{attrs:{src:"/posts/2020/2020-09-03-jenkins-build-kill-process-01.png",alt:""}})]),s._v(" "),e("p",[s._v("然而服务并没有启动：")]),s._v(" "),e("p",[e("img",{attrs:{src:"/posts/2020/2020-09-03-jenkins-build-kill-process-02.png",alt:""}})]),s._v(" "),e("p",[s._v("boot.sh 启动脚本的主要命令如下：")]),s._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("nohup java -Xms300m -Xmx300m -jar ${APP_HOME}/${APP_NAME} > /dev/null 2>&1 &\n")])])]),e("p",[s._v("经过一番面向搜索引擎编程之后，找到了原因和解决办法。")]),s._v(" "),e("h3",{attrs:{id:"原因"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#原因"}},[s._v("#")]),s._v(" 原因")]),s._v(" "),e("p",[s._v("原来 jenkins 有一个 ProcessTreeKiller 组件，这个组件在构建完成之后会杀死跟这次构建相关的的所有衍生进程。\n判断是不是衍生进程的依据就是：该进程启动时的环境变量中的 BUILD_ID。")]),s._v(" "),e("blockquote",[e("p",[s._v("BUILD_ID 是 jenkins 构建时生成的一个任务号。随着构建次数从 1 开始，依次递增。")])]),s._v(" "),e("h3",{attrs:{id:"解决方案"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#解决方案"}},[s._v("#")]),s._v(" 解决方案")]),s._v(" "),e("p",[s._v("解决方案就是在启动 Jar 包这一行脚本之前修改环境变量 BUILD_ID 的值，启动脚本执行之后再改回来。\n其实如果构建任务只是单纯启动 Jar 包的话不改回来也没关系。修改后的构建脚本如下：")]),s._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("#暂存BUILD_ID\nOLD_BUILD_ID = $BUILD_ID\n#修改BUILD_ID\nexport BUILD_ID=dontKillMe\n#启动 Jar 包\n/web-service-jar/house-service/boot.sh house-service.jar restart\n#将BUILD_ID改回原来的值\nBUILD_ID=$OLD_BUILD_ID\n#打印\necho $BUILD_ID\n")])])]),e("p",[s._v("到服务器上查询服务启动结果：")]),s._v(" "),e("p",[e("img",{attrs:{src:"/posts/2020/2020-09-03-jenkins-build-kill-process-03.png",alt:""}})]),s._v(" "),e("p",[s._v("查询该进程的启动环境变量，发现 BUILD_ID 果然已经被修改成了 dontKillMe。查询命令如下：")]),s._v(" "),e("blockquote",[e("p",[s._v("ps eww -p 14639")])]),s._v(" "),e("p",[s._v("ok，至此问题完美解决！")])])}),[],!1,null,null,null);t.default=r.exports}}]);